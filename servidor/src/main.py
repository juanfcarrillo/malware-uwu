import tweepy
from PIL import Image
from io import BytesIO
from steg import encodeMesageToImage
from uploadExternalApi import uploadImage
import sys, os
from dotenv import load_dotenv

load_dotenv()

consumer_key = os.getenv('TWITTER_CONSUME_KEY')
consumer_secret = os.getenv('TWITTER_CONSUME_SECRET')
access_token = os.getenv('TWITTER_ACCESS_TOKEN')
access_token_secret = os.getenv('TWITTER_ACCESS_TOKEN_SECRET')


def main(imageSrcPath, imageDstPath, message):
    # Authenticate to Twitter
    auth = tweepy.OAuth1UserHandler(
        consumer_key, consumer_secret, access_token, access_token_secret
    )
    # Create API object, empezamos la comunicacion con la API
    api = tweepy.API(auth)

    baseImage = Image.open(imageSrcPath, 'r')
    copiedImage = baseImage.copy()
    encodedImage = encodeMesageToImage(copiedImage, message)

    memoryImage = BytesIO()
    encodedImage.save(memoryImage, "PNG")
    memoryImage.seek(0)
    encodedImage.save(imageDstPath)
    uploadedImage = uploadImage(imageDstPath)

    # Subida de imagen sin publicacion
    media = api.media_upload(filename=imagePath, file=memoryImage)
    
    # Actualizamos el feed y publicamos la imagen
    api.update_status(media_ids=[media.media_id_string],
                      status=uploadedImage["data"]["url"])

    print("Imagen subida correctamente")


if __name__ == "__main__":
    imagePath = "./bee.jpg"

    if len(sys.argv) > 1:
        main(sys.argv[2], sys.argv[3], sys.argv[4])
    elif len(sys.argv) == 1:
   		main(imagePath, './bee_encoded.png', 'ping epn.edu.ec')
	
